<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Verify Your Identity - Guest WiFi</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <style>
    body { font-family: 'Inter', sans-serif; }
    .gradient-bg {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 50%, #f093fb 100%);
    }
  </style>
</head>
<body class="gradient-bg min-h-screen flex items-center justify-center p-4">
  <div class="bg-white rounded-2xl shadow-2xl w-full max-w-md p-8">
    <!-- Header -->
    <div class="text-center mb-6">
      <div class="w-16 h-16 bg-purple-100 rounded-full flex items-center justify-center mx-auto mb-4" id="headerIcon">
        <svg class="w-8 h-8 text-purple-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m5.618-4.016A11.955 11.955 0 0112 2.944a11.955 11.955 0 01-8.618 3.04A12.02 12.02 0 003 9c0 5.591 3.824 10.29 9 11.622 5.176-1.332 9-6.03 9-11.622 0-1.042-.133-2.052-.382-3.016z"/>
        </svg>
      </div>
      <h1 class="text-2xl font-bold text-gray-800" id="pageTitle">Verify Your Identity</h1>
      <p class="text-gray-500 mt-2" id="subtitle">Please confirm your information</p>
    </div>

    <!-- Loading State -->
    <div id="loading" class="text-center py-8">
      <div class="animate-spin rounded-full h-12 w-12 border-4 border-purple-500 border-t-transparent mx-auto"></div>
      <p class="text-gray-500 mt-4">Loading your information...</p>
    </div>

    <!-- Contact Found - "Is this you?" prompt with editable fields -->
    <div id="matchFoundForm" class="hidden">
      <div class="bg-green-50 border border-green-200 rounded-lg p-4 mb-6">
        <div class="flex items-start">
          <svg class="w-5 h-5 text-green-500 mt-0.5 mr-2 flex-shrink-0" fill="currentColor" viewBox="0 0 20 20">
            <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"/>
          </svg>
          <div>
            <p class="text-green-800 font-medium">Contact Found!</p>
            <p class="text-green-700 text-sm">We found a contact that might be you.</p>
          </div>
        </div>
      </div>

      <!-- Contact Photo -->
      <div id="contactPhotoContainer" class="hidden mb-4 text-center">
        <img id="contactPhoto" class="w-24 h-24 rounded-full mx-auto object-cover border-4 border-purple-200" />
      </div>

      <!-- Editable Contact Info -->
      <div class="space-y-4 mb-6">
        <!-- Display Name (editable) -->
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-1">Display Name</label>
          <input type="text" id="matchDisplayName"
                 class="w-full px-4 py-3 rounded-lg border border-gray-300 focus:ring-2 focus:ring-purple-500 focus:border-transparent"
                 placeholder="Your name">
          <p class="text-xs text-gray-500 mt-1">This is how your name will appear in the admin panel</p>
        </div>

        <!-- Contact Info (read-only display) -->
        <div class="bg-gray-50 rounded-lg p-3">
          <p class="text-sm text-gray-600">
            <span class="font-medium">Contact:</span> <span id="matchContactName"></span>
          </p>
          <p class="text-sm text-gray-600" id="matchPhoneRow">
            <span class="font-medium">Phone:</span> <span id="matchContactPhone"></span>
          </p>
        </div>

        <!-- Birthdate (editable - can add if missing) -->
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-1">Birthdate</label>
          <input type="date" id="matchBirthdate"
                 class="w-full px-4 py-3 rounded-lg border border-gray-300 focus:ring-2 focus:ring-purple-500 focus:border-transparent">
          <p class="text-xs text-gray-500 mt-1" id="birthdateHint">Optional - will be saved to your contact</p>
        </div>
      </div>

      <div class="pt-4 space-y-3">
        <button type="button" id="yesMeBtn"
                class="w-full py-3 px-4 bg-green-600 hover:bg-green-700 text-white font-semibold rounded-lg transition-colors">
          Yes, This Is Me
        </button>
        <button type="button" id="notMeBtn"
                class="w-full py-3 px-4 bg-gray-100 hover:bg-gray-200 text-gray-700 font-medium rounded-lg transition-colors">
          This Isn't Me
        </button>
      </div>
    </div>

    <!-- No Match Found - Enter phone/birthdate form -->
    <div id="noMatchForm" class="hidden">
      <div class="bg-yellow-50 border border-yellow-200 rounded-lg p-4 mb-6">
        <div class="flex items-start">
          <svg class="w-5 h-5 text-yellow-500 mt-0.5 mr-2 flex-shrink-0" fill="currentColor" viewBox="0 0 20 20">
            <path fill-rule="evenodd" d="M8.257 3.099c.765-1.36 2.722-1.36 3.486 0l5.58 9.92c.75 1.334-.213 2.98-1.742 2.98H4.42c-1.53 0-2.493-1.646-1.743-2.98l5.58-9.92zM11 13a1 1 0 11-2 0 1 1 0 012 0zm-1-8a1 1 0 00-1 1v3a1 1 0 002 0V6a1 1 0 00-1-1z" clip-rule="evenodd"/>
          </svg>
          <div>
            <p class="text-yellow-800 font-medium">Please Identify Yourself</p>
            <p class="text-yellow-700 text-sm">Enter your phone number and birthdate to verify.</p>
          </div>
        </div>
      </div>

      <form id="manualVerifyForm" class="space-y-4">
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-1">Your Name</label>
          <input type="text" id="manualName"
                 class="w-full px-4 py-3 rounded-lg border border-gray-300 focus:ring-2 focus:ring-purple-500 focus:border-transparent"
                 placeholder="Enter your name">
        </div>
        
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-1">Phone Number</label>
          <input type="tel" id="manualPhone" required placeholder="(555) 123-4567"
                 class="w-full px-4 py-3 rounded-lg border border-gray-300 focus:ring-2 focus:ring-purple-500 focus:border-transparent">
        </div>
        
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-1">Birthdate</label>
          <input type="date" id="manualBirthdate" 
                 class="w-full px-4 py-3 rounded-lg border border-gray-300 focus:ring-2 focus:ring-purple-500 focus:border-transparent">
          <p class="text-xs text-gray-500 mt-1">Optional, but helps us verify you</p>
        </div>

        <button type="submit"
                class="w-full py-3 px-4 bg-purple-600 hover:bg-purple-700 text-white font-semibold rounded-lg transition-colors mt-6">
          Verify My Identity
        </button>
      </form>
    </div>

    <!-- Error State with Red X -->
    <div id="errorState" class="hidden text-center py-8">
      <div class="w-20 h-20 bg-red-100 rounded-full flex items-center justify-center mx-auto mb-4">
        <svg class="w-10 h-10 text-red-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
        </svg>
      </div>
      <h2 class="text-xl font-bold text-gray-800 mb-2">Unable to Verify</h2>
        <p class="text-gray-600 mb-6" id="errorStateMessage">Please contact the network administrator about getting WiFi access.</p>
      <button type="button" onclick="window.location.href='/'"
              class="px-6 py-2 bg-gray-100 hover:bg-gray-200 text-gray-700 font-medium rounded-lg transition-colors">
        Go Back
      </button>
    </div>

    <!-- Inline Error Message (for form errors) -->
    <div id="errorMessage" class="hidden mt-4 p-4 bg-red-50 border border-red-200 rounded-lg">
      <p class="text-red-700 text-sm" id="errorText"></p>
    </div>
  </div>

  <script>
    let sessionInfo = null;
    let supportConfig = {
      adminName: null,
      supportMessage: null
    };
    async function loadSupportConfig() {
      try {
        const res = await fetch('/api/support-config');
        if (res.ok) {
          supportConfig = await res.json();
        }
      } catch (e) {
        console.warn('Could not load support config');
      }
    }

    function getSupportMessage(fallback) {
      return (
        (supportConfig && supportConfig.supportMessage) ||
        fallback ||
        'Please contact the network administrator about getting WiFi access.'
      );
    }

    async function loadSessionInfo() {
      try {
        const response = await fetch('/api/session-info');
        sessionInfo = await response.json();

        document.getElementById('loading').classList.add('hidden');

        if (!sessionInfo.authenticated || sessionInfo.authMethod !== 'google') {
          window.location.href = '/';
          return;
        }

        // Check if CardDAV fuzzy match was found
        if (sessionInfo.cardDavContact) {
          showMatchFound();
        } else {
          showNoMatch();
        }
      } catch (error) {
        console.error('Error loading session:', error);
        showInlineError('Failed to load session information. Please try again.');
      }
    }

    function showMatchFound() {
      document.getElementById('matchFoundForm').classList.remove('hidden');
      document.getElementById('subtitle').textContent = 'We found a contact that might be you.';
      
      const contact = sessionInfo.cardDavContact;
      
      // Populate editable display name field
      // Prefer OAuth name if different from contact name (user might want to use their Google name)
      const displayName = sessionInfo.userName || contact.name || '';
      document.getElementById('matchDisplayName').value = displayName;
      
      // Show contact info (read-only for reference)
      document.getElementById('matchContactName').textContent = contact.name || 'Unknown';
      
      if (contact.phone) {
        document.getElementById('matchContactPhone').textContent = formatPhone(contact.phone);
        document.getElementById('matchPhoneRow').classList.remove('hidden');
      } else {
        document.getElementById('matchPhoneRow').classList.add('hidden');
      }
      
      // Populate birthdate field (editable)
      if (contact.birthdate) {
        document.getElementById('matchBirthdate').value = contact.birthdate;
        document.getElementById('birthdateHint').textContent = 'From your contact';
      } else {
        document.getElementById('birthdateHint').textContent = 'Optional - will be saved to your contact';
      }
      
      // Show photo if available
      if (contact.photo) {
        const photoData = contact.photo;
        document.getElementById('contactPhoto').src = photoData.startsWith('data:') 
          ? photoData 
          : `data:image/jpeg;base64,${photoData}`;
        document.getElementById('contactPhotoContainer').classList.remove('hidden');
      }
    }

    function showNoMatch() {
      document.getElementById('noMatchForm').classList.remove('hidden');
      document.getElementById('subtitle').textContent = 'Please enter your information to verify.';
      document.getElementById('manualName').value = sessionInfo.userName || '';
    }

    function showErrorState(message) {
      // Hide all other forms
      document.getElementById('loading').classList.add('hidden');
      document.getElementById('matchFoundForm').classList.add('hidden');
      document.getElementById('noMatchForm').classList.add('hidden');
      document.getElementById('errorMessage').classList.add('hidden');
      
      // Change header icon to red X
      document.getElementById('headerIcon').innerHTML = `
        <svg class="w-10 h-10 text-red-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
        </svg>
      `;
      document.getElementById('headerIcon').className = 'w-16 h-16 bg-red-100 rounded-full flex items-center justify-center mx-auto mb-4';
      
      // Update title
      document.getElementById('pageTitle').textContent = 'Unable to Verify';
      document.getElementById('subtitle').textContent = '';
      
      // Show error state
      document.getElementById('errorStateMessage').textContent = message;
      document.getElementById('errorState').classList.remove('hidden');
    }

    function showInlineError(message) {
      document.getElementById('errorText').textContent = message;
      document.getElementById('errorMessage').classList.remove('hidden');
    }

    function hideInlineError() {
      document.getElementById('errorMessage').classList.add('hidden');
    }

    function formatPhone(phone) {
      if (!phone) return '';
      const cleaned = phone.replace(/\D/g, '');
      if (cleaned.length === 10) {
        return `(${cleaned.slice(0,3)}) ${cleaned.slice(3,6)}-${cleaned.slice(6)}`;
      }
      return phone;
    }

    // Handle "Yes, This Is Me" button
    document.getElementById('yesMeBtn').addEventListener('click', async () => {
      hideInlineError();

      // Get the editable fields
      const displayName = document.getElementById('matchDisplayName').value.trim();
      const birthdate = document.getElementById('matchBirthdate').value;

      if (!displayName) {
        showInlineError('Please enter a display name');
        return;
      }

      try {
        const response = await fetch('/api/verify-identity', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            confirmMatch: true,
            cardDavUid: sessionInfo.cardDavContact?.uid,
            name: displayName,
            birthdate: birthdate || null
          })
        });

        const data = await response.json();

        if (response.ok && data.success) {
          if (data.autoApproved) {
            window.location.href = '/device-select.html';
          } else {
            window.location.href = '/waiting.html';
          }
        } else {
          showInlineError(data.error || 'Verification failed. Please try again.');
        }
      } catch (error) {
        console.error('Verification error:', error);
        showInlineError('An error occurred. Please try again.');
      }
    });

    // Handle "Not Me" button - switch to manual form
    document.getElementById('notMeBtn').addEventListener('click', () => {
      document.getElementById('matchFoundForm').classList.add('hidden');
      showNoMatch();
    });

    // Handle manual verification form
    document.getElementById('manualVerifyForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      hideInlineError();

      const name = document.getElementById('manualName').value.trim();
      const phone = document.getElementById('manualPhone').value;
      const birthdate = document.getElementById('manualBirthdate').value;

      if (!phone) {
        showInlineError('Phone number is required');
        return;
      }

      try {
        const response = await fetch('/api/verify-manual', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ name, phone, birthdate })
        });

        const data = await response.json();

        if (response.ok && data.success) {
          if (data.autoApproved) {
            window.location.href = '/device-select.html';
          } else {
            window.location.href = '/waiting.html';
          }
        } else if (data.notFound) {
          // Show error state with red X (server is source of truth)
          showErrorState(
            data.error || getSupportMessage('No matching contact found. Please contact the network administrator.')
          );
        } else {
          showInlineError(data.error || 'No matching contact found.');
        }
      } catch (error) {
        console.error('Verification error:', error);
        showInlineError('An error occurred. Please try again.');
      }
    });

    /// Load config + session on page load
    (async () => {
      await loadSupportConfig();
      await loadSessionInfo();
    })();
  </script>
</body>
</html>
