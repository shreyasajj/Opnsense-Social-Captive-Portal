<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>WiFi Access Portal</title>

  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">

  <style>
    body { font-family: 'Inter', sans-serif; }
    .gradient-bg {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 50%, #f093fb 100%);
      min-height: 100vh;
    }
    .card {
      backdrop-filter: blur(10px);
      background: rgba(255, 255, 255, 0.95);
    }
    .btn-google { background: #4285F4; }
    .btn-phone {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    }
    .btn-secondary {
      background: rgba(17, 24, 39, 0.08);
    }
  </style>
</head>

<body class="gradient-bg flex items-center justify-center p-4">
  <div class="w-full max-w-md">

    <div class="card rounded-2xl shadow-2xl p-8">

      <!-- Header -->
      <div class="text-center mb-8">
        <h1 class="text-2xl font-bold text-gray-800">WiFi Access Portal</h1>
        <p class="text-gray-500 mt-2">Sign in to connect</p>
      </div>

      <!-- Embedded browser warning -->
      <div id="embedded-warning" class="hidden mb-6 rounded-xl border border-amber-200 bg-amber-50 p-4">
        <p class="text-sm text-amber-900 font-medium">
          Google sign-in is blocked in this Wi-Fi login window.
        </p>
        <p class="text-sm text-amber-900/80 mt-1">
          Open this portal in Safari or Chrome to continue.
        </p>

        <div class="mt-4 space-y-2">
          <a id="open-browser-btn"
             class="btn-secondary w-full py-3 rounded-xl text-center font-medium block"
             target="_blank"
             rel="noopener">
            Open in Safari / Chrome
          </a>

          <button id="toggle-help"
                  class="btn-secondary w-full py-3 rounded-xl font-medium">
            Show instructions
          </button>

          <div id="help-text" class="hidden text-sm text-amber-900/80 bg-white/60 rounded-lg p-3">
            <strong>iPhone:</strong>
            <ol class="list-decimal ml-5 mt-1 space-y-1">
              <li>Close this Wi-Fi popup</li>
              <li>Open Safari</li>
              <li>Go to <b>http://neverssl.com</b></li>
              <li>Tap “Continue with Google”</li>
            </ol>

            <strong class="block mt-3">Android:</strong>
            <ol class="list-decimal ml-5 mt-1 space-y-1">
              <li>Tap “Open in Browser” above</li>
              <li>Use Chrome if prompted</li>
            </ol>
          </div>
        </div>
      </div>

      <!-- Login options -->
      <div id="login-options" class="space-y-4">
        <a id="google-btn"
           href="/auth/google"
           class="btn-google w-full py-3 rounded-xl text-white text-center font-medium block">
          Continue with Google
        </a>

        <div class="text-center text-gray-400">or</div>

        <button id="phone-btn"
                class="btn-phone w-full py-3 rounded-xl text-white font-medium">
          Login with Phone + Birthdate
        </button>
      </div>

      <!-- Phone form -->
      <div id="phone-form" class="hidden mt-4">
        <button id="back-btn" class="text-sm text-gray-500 mb-4">← Back</button>

        <input id="phone-input"
               class="w-full mb-3 p-3 border rounded-xl"
               placeholder="Phone number" />

        <input id="birthdate-input"
               type="date"
               class="w-full mb-4 p-3 border rounded-xl" />

        <button id="submit-phone"
                class="btn-phone w-full py-3 rounded-xl text-white font-medium">
          Verify
        </button>

        <p id="phone-error" class="hidden text-red-500 text-sm mt-2 text-center"></p>
      </div>

    </div>

    <p class="text-center text-white/70 text-sm mt-6">
      By connecting, you agree to the network policy
    </p>

  </div>

<script>
  const googleBtn = document.getElementById('google-btn');
  const embeddedWarning = document.getElementById('embedded-warning');
  const openBrowserBtn = document.getElementById('open-browser-btn');
  const toggleHelp = document.getElementById('toggle-help');
  const helpText = document.getElementById('help-text');

  const phoneBtn = document.getElementById('phone-btn');
  const phoneForm = document.getElementById('phone-form');
  const loginOptions = document.getElementById('login-options');
  const backBtn = document.getElementById('back-btn');

  function isEmbeddedBrowser() {
    const ua = navigator.userAgent || '';
    return /CaptiveNetworkSupport|; wv\)|FBAN|FBAV|Instagram/i.test(ua);
  }

  async function loadPortalUrl() {
    try {
      const res = await fetch('/api/portal-config');
      const cfg = await res.json();

      if (cfg.portalBaseUrl) {
        openBrowserBtn.href = cfg.portalBaseUrl;
      }
    } catch (e) {
      console.warn('Could not load portal base URL');
    }
  }

  function applyEmbeddedUX() {
    if (!isEmbeddedBrowser()) return;

    embeddedWarning.classList.remove('hidden');
    googleBtn.classList.add('hidden');
  }

  toggleHelp.addEventListener('click', () => {
    helpText.classList.toggle('hidden');
  });

  phoneBtn.addEventListener('click', () => {
    loginOptions.classList.add('hidden');
    phoneForm.classList.remove('hidden');
  });

  backBtn.addEventListener('click', () => {
    phoneForm.classList.add('hidden');
    loginOptions.classList.remove('hidden');
  });

  loadPortalUrl();
  applyEmbeddedUX();
</script>

</body>
</html>
